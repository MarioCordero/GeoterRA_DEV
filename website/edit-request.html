<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<link rel="stylesheet" href="./assets/css/style.css">
	<link rel="stylesheet" href="./assets/css/fonts.css">
	<link rel="stylesheet" href="./assets/css/responsive.css">
	<link rel="shortcut icon" type="image/x-icon" href="./GeoterRA.ico">
	<title>Edit Point</title>
</head>

<body>
	<nav class="navbar Montserrat-Regular">
		<div class="logo-container">
			<a href="./index.html"><img id="logo" src="./assets/images/GeoterRA/GeoterRA-Logo.svg" class="header-logo" alt="Webpage logotype"></a>
		</div>
		<div class="menu" id="navbar">
			<a href="./index.html#about-us">Acerca de nosotros</a>
			<a href="./index.html#how-works">Como funciona</a>
			<a href="./index.html#contact-us">Contacto</a>
			<a href="./map.html">Mapa</a>
			<a href="./login.html">Iniciar Sesión</a>
		</div>
	</nav>

	<div class="show-point-container Montserrat-Regular">
		<div class="show-point-container-info Montserrat-Regular">
			<p id="resultChanged"></p>
			<h1>Editar Información del Punto</h1>
			<form id="point-form">
				<label for="point-id">ID:</label>
				<input type="text" id="point-id" readonly>

				<label for="region">Región:</label>
				<input type="text" id="region">

				<label for="coord-x">Coordenada X:</label>
				<input type="text" id="coord-x">

				<label for="coord-y">Coordenada Y:</label>
				<input type="text" id="coord-y">

				<label for="temp">Temperatura:</label>
				<input type="text" id="temp">

				<label for="ph-campo">pH (Campo):</label>
				<input type="text" id="ph-campo">

				<label for="cond-campo">Conductividad (Campo):</label>
				<input type="text" id="cond-campo">
			</form>
			<button id="save-changes">Guardar Cambios</button>
			<svg id="piperDiagram" width="600" height="600"></svg>
			<button id="export-pdf">Exportar a PDF</button>
		</div>
	</div>

	<footer class="footer-container">
		<div class="footer center-text Montserrat-Regular">
			<p>© 2021 Instituto de Investigaciones en Ingeniería - Universidad de Costa Rica.</p>
		</div>
	</footer>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
	<script src="./assets/js/check-session.js" defer></script>
	<script src="./assets/js/web-loader.js"></script>
	<script src="./assets/js/show-point.js"></script>
	<script src="./assets/js/menu-bars.js"></script>
	
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			let pointId = new URLSearchParams(window.location.search).get('id');
			let region = document.getElementById('region');
			let coordX = document.getElementById('coord-x');
			let coordY = document.getElementById('coord-y');
			let temp = document.getElementById('temp');
			let phCampo = document.getElementById('ph-campo');
			let condCampo = document.getElementById('cond-campo');

			// Fetch and populate point data
			function loadPointData() {
				let xhr = new XMLHttpRequest();
				xhr.open("POST", "../../API/get_point_info.php", true);
				xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
				xhr.onreadystatechange = function() {
					if (xhr.readyState === 4 && xhr.status === 200) {
						let response = JSON.parse(xhr.responseText);
						if (response.status === 'success') {
							document.getElementById('point-id').value = response.data.id;
							region.value = response.data.region;
							coordX.value = response.data.coord_x;
							coordY.value = response.data.coord_y;
							temp.value = response.data.temp;
							phCampo.value = response.data.ph_campo;
							condCampo.value = response.data.cond_campo;
						} else {
							alert("Failed to load point data.");
						}
					}
				};
				xhr.send("id=" + pointId);
			}

			// Save changes
			document.getElementById('save-changes').addEventListener('click', function() {
				let xhr = new XMLHttpRequest();
				xhr.open("POST", "../../API/update_point_info.php", true);
				xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

				let data = `id=${pointId}&region=${region.value}&coord_x=${coordX.value}&coord_y=${coordY.value}&temp=${temp.value}&ph_campo=${phCampo.value}&cond_campo=${condCampo.value}`;
				
				xhr.onreadystatechange = function() {
					if (xhr.readyState === 4 && xhr.status === 200) {
						let response = JSON.parse(xhr.responseText);
						if (response.status === 'update_success') {
							alert("Point information updated successfully.");
						} else {
							alert("Failed to update point information.");
						}
					}
				};
				xhr.send(data);
			});

			loadPointData();
		});
	</script>
</body>
</html>
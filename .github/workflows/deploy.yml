name: GeoterRA CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: read
  checks: write

jobs:
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd website
          npm ci

      - name: Lint frontend code
        run: |
          cd website
          npm run lint

      - name: Build frontend
        run: |
          cd website
          npm run build

      - name: Validate API structure
        run: |
          if [ -d "API" ]; then
            echo "âœ… API directory exists"
            if [ ! -f "API/dbhandler.inc.php" ]; then
              echo "âŒ Database handler not found"
              exit 1
            fi
          else
            echo "âŒ API directory not found"
            exit 1
          fi

      - name: Validate database files
        run: |
          if [ -f "database/GeoterRA.sql" ]; then
            echo "âœ… Database schema file exists"
          else
            echo "âŒ Database schema file not found"
            exit 1
          fi

      - name: Comment PR status
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('ðŸ” PR Validation'));
            const body = "âœ… **PR Validation Results**\n\n" +
              "**Frontend Build**: âœ… Passed\n" +
              "**Code Linting**: âœ… Passed\n" +
              "**API Structure**: âœ… Validated\n" +
              "**Database Schema**: âœ… Validated\n\n" +
              "Ready for review and merge! ðŸš€";
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  build-and-deploy:
    name: Deploy to main & Server
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Fetch headerWeb content
        run: |
          git fetch origin headerWeb:refs/remotes/origin/headerWeb || true
          mkdir -p /tmp/headerWeb-content
          git --work-tree=/tmp/headerWeb-content checkout origin/headerWeb -- . 2>/dev/null || true

      - name: Update files from headerWeb
        run: |
          set -euxo pipefail
          HDR=/tmp/headerWeb-content

          # Copy website (complete)
          if [ -d "$HDR/website" ]; then
            rm -rf website
            cp -r "$HDR"/website ./website
            echo "âœ… website updated"
          fi

          # Copy API
          if [ -d "$HDR/API" ]; then
            rm -rf API
            cp -r "$HDR"/API ./API
            echo "âœ… API updated"
          fi

          # Copy database
          if [ -d "$HDR/database" ]; then
            rm -rf database
            cp -r "$HDR"/database ./database
            echo "âœ… database updated"
          fi

      - name: Commit and push
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -euxo pipefail
          git add -A
          if git diff --staged --quiet; then
            echo "ðŸ“ No changes to commit"
          else
            COMMIT_MSG="ðŸš€ Deploy from headerWeb - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git commit -m "$COMMIT_MSG" || true
            git push "https://${GH_PAT}@github.com/${{ github.repository }}.git" main
            echo "âœ… main updated"
          fi

      - name: Trigger server deployment
        run: |
          echo "ðŸŒ Triggering server deployment..."
          curl -X POST --max-time 30 --retry 3 --retry-delay 5 \
            http://163.178.171.105/pull.sh || echo "âš ï¸ Server trigger warning"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
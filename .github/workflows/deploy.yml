name: GeoterRA CI/CD Pipeline

on:
  # Trigger on pull requests to headerWeb branch
  pull_request:
    branches:
      - headerWeb
    types: [opened, synchronize, reopened]
  
  # Trigger on push to headerWeb (when PR is merged)
  push:
    branches:
      - headerWeb

permissions:
  contents: write
  pull-requests: read
  checks: write

jobs:
  # Job 1: Validate and Test (runs on PR)
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd website
          npm ci

      - name: Lint frontend code
        run: |
          cd website
          npm run lint

      - name: Build frontend (test)
        run: |
          cd website
          npm run build

      - name: Validate Android build files
        run: |
          if [ -d "Android/Development" ]; then
            echo "âœ… Android project structure is valid"
            # Check if critical Android files exist
            if [ ! -f "Android/Development/build.gradle.kts" ]; then
              echo "âŒ Android build.gradle.kts not found"
              exit 1
            fi
            if [ ! -f "Android/Development/app/build.gradle.kts" ]; then
              echo "âŒ Android app build.gradle.kts not found"
              exit 1
            fi
            echo "âœ… Android build files are present"
          else
            echo "âš ï¸ Android directory not found"
          fi

      - name: Validate API structure
        run: |
          if [ -d "API" ]; then
            echo "âœ… API directory exists"
            # Check for critical API files
            if [ ! -f "API/dbhandler.inc.php" ]; then
              echo "âŒ Database handler not found"
              exit 1
            fi
            echo "âœ… API structure is valid"
          else
            echo "âŒ API directory not found"
            exit 1
          fi

      - name: Validate database files
        run: |
          if [ -f "database/GeoterRA.sql" ]; then
            echo "âœ… Database schema file exists"
          else
            echo "âŒ Database schema file not found"
            exit 1
          fi

      - name: Comment PR status
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ðŸ” PR Validation Results')
            );
            
            const body = `ðŸ” **PR Validation Results**
            
            **Frontend Build**: âœ… Passed
            **Code Linting**: âœ… Passed  
            **Android Structure**: âœ… Validated
            **API Structure**: âœ… Validated
            **Database Schema**: âœ… Validated
            
            This PR is ready for review and merge! ðŸš€`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # Job 2: Build and Deploy (runs on push to headerWeb)
  build-and-deploy:
    name: Build & Deploy to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/headerWeb'
    
    steps:
      - name: Checkout headerWeb
        uses: actions/checkout@v4
        with:
          ref: headerWeb
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Install dependencies
        run: |
          cd website
          npm ci

      - name: Build frontend for production
        run: |
          cd website
          npm run build

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://${GH_PAT}@github.com/MarioCordero/GeoterRA_DEV.git
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

      - name: Prepare production deployment
        run: |
          # Fetch and prepare main branch
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          
          # Create temporary backup of .git
          TMP_GIT=$(mktemp -d)
          cp -r .git "$TMP_GIT"/
          
          # Clean main branch
          git clean -fdx
          rm -rf ./* .[^.] .??* 2>/dev/null || true
          
          # Restore .git
          cp -r "$TMP_GIT"/.git ./
          
          # Checkout headerWeb content to temporary location
          git --work-tree=/tmp/headerWeb-content checkout headerWeb -- . 2>/dev/null || true
          
          # Copy production files
          echo "ðŸ“¦ Copying production files..."
          
          # Copy Android project
          if [ -d "/tmp/headerWeb-content/Android" ]; then
            cp -r /tmp/headerWeb-content/Android ./ 
            echo "âœ… Android project copied"
          fi
          
          # Copy API
          if [ -d "/tmp/headerWeb-content/API" ]; then
            cp -r /tmp/headerWeb-content/API ./
            echo "âœ… API copied"
          fi
          
          # Copy database
          if [ -d "/tmp/headerWeb-content/database" ]; then
            cp -r /tmp/headerWeb-content/database ./
            echo "âœ… Database files copied"
          fi
          
          # Copy built frontend
          if [ -d "/tmp/headerWeb-content/website/dist" ]; then
            mkdir -p website
            cp -r /tmp/headerWeb-content/website/dist ./website/
            echo "âœ… Built frontend copied"
          fi
          
          # Copy documentation and config files
          if [ -f "/tmp/headerWeb-content/readme.md" ]; then
            cp /tmp/headerWeb-content/readme.md ./
            echo "âœ… README copied"
          fi
          
          if [ -f "/tmp/headerWeb-content/pull.sh" ]; then
            cp /tmp/headerWeb-content/pull.sh ./
            echo "âœ… Deployment script copied"
          fi
          
          # Copy any additional config files
          cp /tmp/headerWeb-content/*.md ./ 2>/dev/null || true
          cp /tmp/headerWeb-content/*.pdf ./ 2>/dev/null || true
          cp /tmp/headerWeb-content/*.gpx ./ 2>/dev/null || true

      - name: Commit and push to main
        run: |
          # Add all changes
          git add .
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "ðŸ“ No changes to commit"
          else
            # Create commit with timestamp and commit info
            COMMIT_MSG="ðŸš€ Production build from headerWeb"
            COMMIT_MSG="${COMMIT_MSG} - $(date +'%Y-%m-%d %H:%M:%S UTC')"
            COMMIT_MSG="${COMMIT_MSG} - SHA: ${GITHUB_SHA:0:8}"
            
            git commit -m "$COMMIT_MSG"
            git push origin main
            echo "âœ… Changes pushed to main branch"
          fi
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

      - name: Trigger server deployment
        run: |
          echo "ðŸŒ Triggering server deployment..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            --max-time 30 \
            --retry 3 \
            --retry-delay 5 \
            http://163.178.171.105/pull.sh)
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Server deployment triggered successfully"
          else
            echo "âš ï¸ Server deployment trigger returned status: $HTTP_STATUS"
          fi

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`headerWeb\` â†’ \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${GITHUB_SHA:0:8}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Components Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android Application" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PHP REST API" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database Schema" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… React Frontend (Built)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Server Status:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Deployment trigger sent to production server" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ‰ Deployment completed successfully!**"